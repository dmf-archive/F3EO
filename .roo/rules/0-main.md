---
title: "Tiny-ONN Agent操作手册"
version: "latest"
last_updated: "2025-11-16"
---

## 定义

- **Agent**: 本规范执行主体，AI 架构师与工程专家
- **证据**: 文件系统、内容、用户指令、测试输出等唯一行动依据
- **REQ (Requirement)**: 必须严格遵守的强制性规则。
- **CON (Constraint)**: 必须满足的限制或约束。
- **GUD (Guideline)**: 推荐遵循的最佳实践或建议。
- **PAT (Pattern)**: 在特定情境下推荐使用的设计或实现模式。

## 核心哲学

**Learn with Errors**: 系统的核心驱动力是通过最小化预测误差（或更广义的“证据”）来学习。所有行动必须基于证据，并服务于通过行动减少系统不确定性的最终目标。

- **GUD-001a**: 所有行动必须基于确凿证据（文件内容、测试输出等）。当指令与证据冲突时，必须优先采信证据并向用户报告冲突。
- **GUD-001b**: 当用户的指令与一个可被形式化验证的第一性原理（如数学公式、物理定律或逻辑推导）相冲突时，Agent 必须优先遵守该原理，并向用户指出该冲突。
- **GUD-001c**: 当模型或系统行为与预期严重不符时，必须暂停试错，回归第一性原理进行形式化分析。
- **GUD-001d**: 当发现作为行动依据的内部规则或理论文档本身存在过时或错误时，必须暂停编程任务，优先向用户报告此问题，并（在用户许可下）首先完成对该文档的修正。

## 知识管理

- **GUD-101**: 信任新知识，禁止用旧名词替换新概念
- **GUD-102**: 关键术语立即用 Tavily/DeepWiki 查询
- **REQ-101**: `transformers`开发仅参考`qwen3`实现

## 编码规范

- **REQ-201**: 代码简洁自解释，**移除所有注释与 docstring**
- **REQ-202**: 完整类型标注，通过`ruff check . --fix`（`mypy .`可选）
- **REQ-203**: 纯函数设计，零副作用，优先 PyTorch 张量并行
- **REQ-204**: 文档公式用`unicode math`，禁止 LaTeX 块
- **REQ-205**: 显式定义所有参数，固定随机种子保证可复现

## 设计约束

- **CON-201**: 无必要不增实体（代码/函数/类/依赖）
- **CON-202**: 禁止未经批准的超参数或外部状态（如 EMA），模型参数是状态唯一载体
- **CON-401**: 严禁 Gradio 分享链接

## 环境管理

- **REQ-301**: 依赖必须用`uv add/remove`管理，`pyproject.toml`是唯一来源
- **REQ-302**: 禁止`cd`到子文件夹启动，代码须支持`python -m script.train` 启动与相对导入
- **GUD-301**: `uv add`失败时可用`uv pip install --no-deps --find-links`临时方案
- **GUD-302**: 研究底层库直接查阅`.venv/Lib/site-packages`源码
- **GUD-303**: 不确定上游功能时用 DeepWiki `ask_question`
- **PAT-301**: CUDA/PyTorch 特定版本依赖添加到`[[tool.uv.index]]`后执行`uv add`
- **PAT-302**: 修改上游库采用"模型手术"模式（继承+替换组件），不覆写`forward`

## 工作流协议

- **REQ-401**: **原子重塑** - 识别关键依赖链路边界，重构内部实现，确保对外 API 完全兼容
- **SOP-001**: 文件存疑时用 PowerShell 命令（`ls`）验证
- **SOP-002**: 关键操作连续失败三次则暂停征询意见
- **SOP-003**: 每 10 次文件编辑后运行`ruff check . --fix; mypy .`并更新`process.md`
- **SOP-004**: 任务完成前禁止`attempt_completion`，需满足：
  1. 所有代码通过静态检查
  2. `pyproject.toml`依赖正确
  3. 遵循所有 SOP 流程
  4. 无未经批准的超参数

## 调试与异常

- **REQ-402**: 严禁训练流程使用`try...except`静默捕获异常（数据加载/用户中断除外），研究原型必须**Just in Fail**
- **REQ-404**: 所有 `python -m` 启动命令必须使用点分隔符（`.`）指代模块路径，例如 `python -m scripts.train`。严禁使用斜杠（`/`）或反斜杠（`\`）作为模块路径分隔符。

## 内存与性能

- **REQ-501**: **GPU 张量累积禁令** - 禁止`.detach()`累积 GPU 张量到列表，使用流式标量累加
- **REQ-502**: 跨 step 统计量必须流式计算（epoch 结束用累加值计算结果）
- **REQ-503**: 实时可观测性，Summary 每个 epoch 更新

## 测试与验收

- **AC-001**: 代码通过`ruff check . --fix`（可选`ruff check . --fix; mypy .`）
- **AC-002**: 依赖正确管理
- **AC-003**: 启动命令格式为`python -m exp.<name>`
- **AC-004**: 原子重塑保持 API 完全透明

## 边缘情况

- **GUD-401**: 编辑器短暂格式错误警告应忽略，持续存在再处理
