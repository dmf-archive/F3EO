# AdaF3E: Adaptive Fisher Free-Energy Optimizer

> 核心论断：将三阶梯度 `H·g` 化为“三阶矩”，作为对角预处理器融入 Adam 的分母，实现对曲率的自适应感知。

## 1. 背景与动机

F3EO/F3EWD 的“加性修正”范式 (`g_eff = g - β·(H·g)`) 被证明效率不足。其根本原因在于，三阶信息 `H·g` 仅作为与 `g` 同等地位的向量被相加，随后整个混合体被 Adam 的自适应分母 `sqrt(v)` 不加区分地归一化。这导致 `H·g` 中蕴含的宝贵曲率信息被“压制”，无法像真正的二阶方法那样，通过缩放步长来有效穿越平坦区域或减速于悬崖峭壁。

我们必须回归到二阶方法的核心——**预处理 (Preconditioning)**。但 `H·g` 是一个向量，无法像矩阵 `H` 那样求逆。因此，我们将 `H·g` 化为一个新的**三阶矩 (third moment)**，并将其作为**对角预处理器**融入 Adam 的分母，实现对**当前局部曲率**的自适应感知。

## 2. 核心思想：引入三阶矩 `c` (Curvature)

我们将三阶信息 `H·g` 提炼为一个新的矩 `c`，称为**曲率矩 (curvature moment)**。

`cₜ = γ·cₜ₋₁ + (1-γ)·|(H·g)ₜ|`

- `H·g` 是 Hessian-向量积，其分量 `(H·g)ᵢ` 衡量了梯度 `gᵢ` 对参数 `θᵢ` 变化的敏感度，即曲率在 `g` 方向上的投影。
- 我们取其绝对值 `|(H·g)ᵢ|`，因为我们关心的是曲率的**大小**而非方向。
- `γ` 是一个新的超参数，控制三阶矩的衰减率，类似于 Adam 的 `β₁` 和 `β₂`。

## 3. AdaF3E 的完整更新规则

1. **计算梯度和三阶信息** (每个 step)：
    `gₜ = ∇L(θₜ₋₁)`
    `(H·g)ₜ = ∇(||gₜ||²)` (通过双反向传播)

2. **更新一阶矩 (动量)**：
    `mₜ = β₁·mₜ₋₁ + (1-β₁)·gₜ`

3. **更新二阶矩 (方差)**：
    `vₜ = β₂·vₜ₋₁ + (1-β₂)·gₜ²`

4. **更新三阶矩 (曲率)**：
    `cₜ = γ·cₜ₋₁ + (1-γ)·|(H·g)ₜ|`

5. **偏置修正**：
    `m̂ₜ = mₜ / (1 - β₁ᵗ)`
    `v̂ₜ = vₜ / (1 - β₂ᵗ)`
    `ĉₜ = cₜ / (1 - γᵗ)`

6. **最终更新 (核心创新)**：
    `Δθₜ = -η · m̂ₜ / (√v̂ₜ + α·ĉₜ + ε)`

## 4. 工作方式与物理语义

`AdaF3E` 的分母 `(√v̂ₜ + α·ĉₜ + ε)` 是一个**混合对角预处理器**，它同时感知两种信息：

- **`√v̂ₜ` (历史梯度大小)**：继承自 Adam，负责处理稀疏梯度和参数缩放问题，保证基础的收敛稳定性。它回答：“这个参数过去移动得多吗？”
- **`α·ĉₜ` (当前曲率大小)**：`AdaF3E` 的核心创新。它利用三阶信息 `H·g` 来感知当前的局部几何。它回答：“这个参数现在处于一个地形剧烈变化的区域吗？”

**协同工作机制：**

- **平坦区域 (Shallow Minima)**：`g` 小, `H·g` 也可能小。`√v̂` 和 `ĉ` 都小，分母小，有效学习率**相对较大**，从而加速穿越平坦高原。
- **尖锐区域 (Sharp Minima)**：`g` 可能小（在极小值点附近），但 `H·g` 会很大。此时，`√v̂` 可能不大，但 `ĉ` 会变得很大，导致分母**显著增大**，有效学习率**急剧减小**。这使得优化器能在尖锐的“悬崖峭壁”前自动“踩刹车”，防止步子太大“飞出”最小值点，从而提高了训练的稳定性。
- **鞍点 (Saddle Points)**：在鞍点，`g` 趋近于零，但 `H` 具有正负特征值。`H·g` 不一定为零，可以帮助提供逃离鞍点的额外信息，调节步长。

## 5. 与现有 F3E 系列的对比

| 特性 | F3EO/F3EWD (加性修正) | AdaF3E (乘性预处理) |
| :--- | :--- | :--- |
| **三阶信息利用方式** | 作为与 `g` 同等地位的**加性向量** | 作为**对角预处理器**融入分母 |
| **对曲率的感知** | 间接，通过向量加法影响方向 | 直接，通过分母项调制步长 |
| **与 Adam 的交互** | 三阶信息被 Adam 的 `sqrt(v)` 无差别归一化 | 三阶信息直接参与构造 Adam 的**有效分母** |
| **理论优势** | 计算廉价，概念简单 | 更忠实地模仿二阶方法的预处理思想，有望实现曲率自适应 |

## 6. 未来工作

1. **原型实现**: 基于 `torch.optim.Adam` 开发 `AdaF3E` 优化器。
2. **超参数研究**: 研究 `γ` (三阶矩衰减) 和 `α` (曲率强度) 的自适应策略，降低调参敏感度。
3. **实验验证**: 在 CIFAR-10 和 WikiText-2 任务上，与 `AdamW` 和 `F3EWD` 进行对照实验，验证其收敛速度和稳定性。
