# F3EL: Fast Fisher Free-Energy Optimizer with Loss-scaling

## 目的

解决 F3EO 训练后期因三阶复杂度梯度 `δ_meta` 持续过强导致的性能停滞与过拟合问题。

## 核心思想

F3EO 的核心是最大化模型复杂度（以 `Tr(ℱ)` 为代理），这在训练早期能有效探索参数空间。然而，在训练后期，当模型已接近收敛时，这种“复杂度最大化”倾向会成为过拟合的主要来源，因为它迫使模型在已经很小的误差上继续寻找更复杂的、不必要的解。

F3EL 引入了一个内生的、由误差驱动的正则化机制，旨在维持一种**自由能原理（FEP）所要求的非平衡稳态**。它用当前批次的主损失 `L` 对 `δ_meta` 进行缩放：

`g_eff = g − L · δ_meta`

- **误差大（训练早期）**: `L` 较大，`δ_meta` 的影响被放大，F3EL 的行为接近 F3EO，快速探索并增加模型复杂度。
- **误差小（训练后期）**: `L` 趋近于零，`δ_meta` 的影响被自动削弱，优化器平滑地过渡到纯粹的一阶梯度微调（类似 Adam），从而抑制过拟合，稳定收敛。

这种机制将“最大化复杂度”的目标与“最小化误差”的最终目的动态地联系起来，是实现真正协同度的关键一步。

## 实现要点

- `step()` 新增可选 `loss` 参数。
- 若 `loss_scaling=True` 且 `loss` 有效，则用 `loss.detach()` 缩放 `meta_grad`。
- 开关 `loss_scaling` 便于进行消融研究。

## 工程上的替代方案

一个更简单、更符合工程实践的替代方案是采用混合优化策略：在训练早期使用 F3EO 以利用其快速探索的优势，在训练后期（例如，当验证集性能开始停滞时）直接切换到标准的 AdamW 优化器。这种方法虽然在理论上不够优美，但能有效节约约一半的算力（因为不再需要双反向传播），并可能达到相似的性能。

一个理论上更纯粹的替代方案是使用预测完整性（PI）而不只是主损失（`main_loss`）来调控三阶梯度的强度。但这需要引入至少两个新的超参数（例如，用于平衡不准确性成本和复杂度成本的 `α` 和 `γ`），因此被推迟到更后期进行研究。

## 提要

**状态**: 实验已暂停。
**原因**: F3EO 主实验表现远超预期，在 CIFAR-10 上仅用 28 epoch 即达到 90.6% 验证准确率，按此趋势 50 epoch 即可逼近 95%。因此，当前优先级为全力推进 F3EO，F3EL 作为技术储备，暂时不急。
