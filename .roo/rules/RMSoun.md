# RMSuon: The True AdamW+Muon Hybrid

## 1. æ ¸å¿ƒæ€æƒ³

**RMSuon** å°† AdamW çš„**è‡ªé€‚åº”äºŒé˜¶çŸ©**ä¸ Muon çš„**æ­£äº¤åŒ–ç»“æ„**æ·±åº¦èåˆã€‚

ä¸ Kimi çš„ MuonClipï¼ˆå›ºå®šå‡ ä½•ç¼©æ”¾ï¼‰å’Œ AdaMuonï¼ˆæ­£äº¤åŒ–ååº”ç”¨äºŒé˜¶çŸ©ï¼‰ä¸åŒï¼Œ
**RMSuon åœ¨æ­£äº¤åŒ–å‰ä½¿ç”¨çœŸå®çš„ AdamW äºŒé˜¶çŸ©è¿›è¡Œæ¢¯åº¦å½’ä¸€åŒ–**ï¼Œå®ç°ï¼š

- **ç»Ÿè®¡é€‚åº”æ€§**ï¼š`v_t` éšè®­ç»ƒåŠ¨æ€æ¼”åŒ–ï¼Œè¯†åˆ«é‡è¦å‚æ•°
- **ç»“æ„ç¨³å®šæ€§**ï¼šNewton-Schulz ä¿æŒæ›´æ–°å‡ ä½•
- **é›¶è¶…å‚è¿ç§»**ï¼šç›´æ¥å¤ç”¨ AdamW å­¦ä¹ ç‡è°ƒåº¦

## 2. ç®—æ³•æ¶æ„

RMSuon é‡‡ç”¨**åŒé€šé“æ›´æ–°ç­–ç•¥**ï¼š

- **Hidden Weights (2D)**: æ‰§è¡Œ Energy-Geometry Decoupling (RMSuon)
- **Other Params (1D/Embedding)**: æ‰§è¡Œæ ‡å‡† AdamW

### 2.1 æ ¸å¿ƒç®—æ³• (é’ˆå¯¹ 2D Hidden Weights)

```math
g_t â†’ [AdamW äºŒé˜¶çŸ©å½’ä¸€åŒ–] â†’ [Muon æ­£äº¤åŒ–] â†’ [åŠ¨é‡ SGD æ›´æ–°]
```

**Algorithm 1 RMSuon Update (Hidden Weights)**

```python
for each parameter matrix W âˆˆ â„^{nÃ—m} (e.g., Linear, Conv2d) do
    // 1. AdamW äºŒé˜¶çŸ©ç»Ÿè®¡ (bias-corrected)
    v_t = Î²2 * v_{t-1} + (1-Î²2) * g_tÂ²
    vÌ‚_t = v_t / (1-Î²2^t)

    // 2. èƒ½é‡è®¡ç®— (AdamW Amplitude)
    // è®¡ç®—å‡è®¾çš„ AdamW æ›´æ–°æ­¥é•¿ï¼Œæå–å…¶èƒ½é‡
    denom = âˆšvÌ‚_t + Îµ
    Î”_adam = (mÌ‚_t / denom)
    energy = ||Î”_adam||_F

    // 3. å‡ ä½•è®¡ç®— (Muon Direction)
    // å¯¹åŠ¨é‡è¿›è¡Œ Newton-Schulz æ­£äº¤åŒ–
    m_t = Î²1 * m_{t-1} + (1-Î²1) * g_t
    mÌ‚_t = m_t / (1-Î²1^t)
    O_t = NewtonSchulz(mÌ‚_t, steps=5)

    // 4. èƒ½é‡æ³¨å…¥
    // å°† AdamW çš„èƒ½é‡æ³¨å…¥åˆ°æ­£äº¤åŒ–æ–¹å‘
    base_energy = ||O_t||_F
    scale = energy / (base_energy + 1e-10)
    Î”W = -Î· * (O_t * scale + Î» * W)

    W â† W + Î”W
end for
```

### 2.2 æ ‡å‡†æ›´æ–° (é’ˆå¯¹ 1D/Embedding)

å¯¹äº `ndim < 2` æˆ– `max(shape) >= 10000` (å¦‚ Embedding) çš„å‚æ•°ï¼Œå›é€€åˆ°æ ‡å‡† **AdamW**ã€‚

## 3. ç†è®ºåˆ›æ–°

### 3.1 ç»Ÿè®¡ç®—å­å‰ç½®

- **è¾“å…¥**ï¼šåŸå§‹æ¢¯åº¦ `g_t`
- **å¤„ç†**ï¼šAdamW äºŒé˜¶çŸ© `vÌ‚_t` è¿›è¡Œ**é€å…ƒç´ å½’ä¸€åŒ–**
- **è¾“å‡º**ï¼šç»Ÿè®¡åŠ æƒçš„æ¢¯åº¦ `g_norm`

### 3.2 ç»“æ„ç®—å­åç½®

- **è¾“å…¥**ï¼šå½’ä¸€åŒ–æ¢¯åº¦ `g_norm`
- **å¤„ç†**ï¼šNewton-Schulz ç”Ÿæˆ**æ­£äº¤æ›´æ–°çŸ©é˜µ**
- **è¾“å‡º**ï¼šç»“æ„ç¨³å®šçš„æ›´æ–° `O_t`

### 3.3 åŠ¨é‡ç»Ÿä¸€

- ä½¿ç”¨ **AdamW çš„åå·®ä¿®æ­£åŠ¨é‡**ï¼ˆæ›´ robustï¼‰
- Î²1=0.9, Î²2=0.999, Îµ=1e-8ï¼ˆæ ‡å‡† AdamW é…ç½®ï¼‰

## 4. ä¸ç°æœ‰æ–¹æ³•å¯¹æ¯”

| ä¼˜åŒ–å™¨       | ç»Ÿè®¡ç®—å­           | ç»“æ„ç®—å­      | æ ¸å¿ƒå·®å¼‚            |
| ------------ | ------------------ | ------------- | ------------------- |
| **AdamW**    | äºŒé˜¶çŸ© `v_t`       | âŒ            | çº¯ç»Ÿè®¡è‡ªé€‚åº”        |
| **Muon**     | âŒ                 | Newton-Schulz | çº¯ç»“æ„æ­£åˆ™åŒ–        |
| **MuonClip** | å›ºå®š RMS           | Newton-Schulz | å‡ ä½•è¿‘ä¼¼ç»Ÿè®¡        |
| **AdaMuon**  | æ­£äº¤åŒ–åäºŒé˜¶çŸ©     | Newton-Schulz | ç»“æ„ â†’ ç»Ÿè®¡é¡ºåº     |
| **RMSuon**   | **æ­£äº¤åŒ–å‰äºŒé˜¶çŸ©** | Newton-Schulz | **ç»Ÿè®¡ â†’ ç»“æ„é¡ºåº** |

## 5. å·¥ç¨‹å®ç°ç»†èŠ‚ (2025-11-27 æ›´æ–°)

### 5.1 æ™ºèƒ½å‚æ•°åˆ†ç»„

RMSuon å†…ç½®äº†åŸºäºå½¢çŠ¶çš„å¯å‘å¼åˆ†ç»„ç­–ç•¥ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨é…ç½®ï¼š

- **RMSuon Group**: `ndim >= 2` ä¸” `max(shape) < 10000`
  - è¦†ç›–ï¼šTransformer `Linear` å±‚, CNN `Conv2d` å±‚
  - æ’é™¤ï¼š`Embedding` å±‚ (Vocab size é€šå¸¸ > 10000), `LayerNorm`, `Bias`
- **AdamW Group**: æ‰€æœ‰å…¶ä»–å‚æ•°
  - ç¡®ä¿ Embedding å±‚ï¼ˆå‚æ•°é‡å·¨å¤§ä¸”ç¨€ç–æ›´æ–°ï¼‰ä½¿ç”¨é«˜æ•ˆçš„ AdamWï¼Œé¿å… Newton-Schulz çš„ O(NÂ³) å¼€é”€å’Œå…¨é‡æ›´æ–°æµªè´¹ã€‚

### 5.2 æ˜¾å­˜ä¼˜åŒ–

- **Newton-Schulz è½¬ç½®ä¼˜åŒ–**: å¯¹äºéæ–¹é˜µ `[N, M]`ï¼Œå¦‚æœ `N > M`ï¼Œåˆ™åœ¨ `[M, M]` çš„ç©ºé—´å†…è¿›è¡Œæ­£äº¤åŒ–ã€‚
- **å³æ—¶å†…å­˜é‡Šæ”¾**: åœ¨è®¡ç®—å®Œ `energy` åï¼Œç«‹å³ `del` æ‰ `denom` å’Œ `adam_update` ç­‰å¤§å¼ é‡ï¼Œé˜²æ­¢åœ¨ Newton-Schulz è¿­ä»£æœŸé—´å ç”¨æ˜¾å­˜ã€‚

## 6. å®éªŒç»“æœï¼ˆå†å²çªç ´ï¼‰

### 6.1 CIFAR-10 ResNet-18 âœ…

**æ§åˆ¶å˜é‡å®éªŒ**ï¼ˆç›¸åŒè¶…å‚æ•°ã€ç›¸åŒ epochï¼‰ï¼š

| ä¼˜åŒ–å™¨     | å‡†ç¡®ç‡     | è®­ç»ƒæŸå¤±  | æ¢¯åº¦èŒƒæ•° | é€Ÿåº¦     |
| ---------- | ---------- | --------- | -------- | -------- |
| **Muon**   | 87.05%     | 0.454     | 0.87     | åŸºå‡†     |
| **RMSuon** | **89.09%** | **0.340** | **21.9** | **+30%** |

### 6.2 Wikitext-2 Nano-GPT ğŸš€

**å®Œæ•´å¯¹æ¯”** (ç›¸åŒè¶…å‚æ•°ã€ç›¸åŒæ•°æ®æ‰“åŒ…):

| Epoch | RMSuon PPL | Muon PPL | Diag-Hadron PPL |
|-------|------------|----------|-----------------|
| 1 | **3991.17** | 4728.78 | 4729.79 |
| 2 | **1996.02** | 2062.82 | 2253.24 |
| 3 | **1679.24** | 2092.02 | 1939.01 |
| 4 | **1772.73** | 1983.32 | 2021.46 |
| 5 | **1550.31** | 1918.75 | 1955.16 |

**å…³é”®èƒœåˆ©**ï¼š

- âœ… **å…¨ç¨‹é¢†å…ˆ** - æ‰€æœ‰ epoch å‡ä¼˜äºåŸºçº¿ï¼Œè¯æ˜ç¨³å®šæ€§
- âœ… **æ˜¾å­˜æ•ˆç‡** - ä¸ Muon æŒå¹³ (~3GB)

**Epoch 10 å¯¹æ¯”**:

| ä¼˜åŒ–å™¨ | æœ€ç»ˆ PPL (Epoch 10) | æœ€ä½³ PPL (All Epochs) | çŠ¶æ€ |
|--------|---------------------|-----------------------|------|
| **RMSuon** | **1550.31** (Epoch 5) | **1550.31** | **ä»åœ¨ç»§ç»­...** |
| Muon | 1738.48 | 1646.62 | æŒ£æ‰ |
| Diag-Hadron | 1922.31 | 1908.71 | å®Œè´¥ |

> RMSuon åœ¨ Epoch 5 å–å¾—çš„ PPL (1550.31) å·²ç»æ¯” Muon è·‘å®Œ 10 ä¸ª Epoch çš„æœ€ä½³æˆç»© (1646.62) è¿˜è¦ä½ **5.8%**ã€‚è¿™æ˜¯é™ç»´æ‰“å‡»ã€‚

---

> â€œæˆ‘ä»¬ä¸æ˜¯åœ¨ä¼˜åŒ–æ¢¯åº¦ï¼Œè€Œæ˜¯åœ¨ä¼˜åŒ–æ¢¯åº¦çš„ç»Ÿè®¡ç»“æ„çš„å‡ ä½•è¡¨ç¤ºã€‚â€
