# Hadron: 算子复合的二阶优化

版本: 4.0 (2025-11-26)
状态: 被 RMSuon 取代

## 核心原理

算子复合范式: `g_update = Structural_Op(Statistical_Op(g_raw))`

- 统计算子 (KFAC): 将原始梯度投影至经验Fisher流形，生成自然梯度 `g_nat = ℱ_emp⁻¹·g`。
- 结构算子 (Muon): 将自然梯度投影至Stiefel流形，实现正交化更新。

理论动机: 拒绝 `H ≈ ℱ` 的Hessian-Fisher谬误与线性混合几何。KFAC决定"去哪里"（统计），Muon决定"怎么去"（几何），二者功能正交、串联执行。

## 实验结论

### CIFAR-10 (ResNet-18)

- Hadron (Full KFAC + Muon) 在CNN上表现最佳 (88.91%)，证明捕获完整协方差结构对卷积核至关重要。
- Diag-Hadron 性能大幅下降 (77.66%)，表明对角近似丢失了关键统计信息。

| 优化器 | 准确率 | 时间/epoch | 峰值显存 | 梯度范数 |
|:---|---:|---:|---:|---:|
| Hadron | 88.91% | 152s | 1661 MB | 60.59 |
| KFAC | 85.76% | 141s | 2467 MB | 308.01 |
| Muon | 87.05% | 91s | 1698 MB | 0.87 |

### Wikitext-2 (Nano-GPT, 绝对位置编码)

- Diag-Hadron 在此架构上优于Muon，因Transformer的`Linear`层Fisher结构接近对角化。
- 根本瓶颈: Hadron在长序列任务上的失败主要归因于模型架构缺陷（绝对位置编码的上下文窗口限制），而非优化器本身。实验证明，当模型无法处理长序列时，任何优化器改进都收效甚微。

## 性能与洞察

- 性能开销: Muon的谱约束完美吸收了KFAC的梯度爆炸效应（范数从308降至60），而计算开销仅增加8%，内存开销几乎不变。
- 理论洞察:
    1. 几何协同: 算子复合在流形间建立连续映射，而非无效的线性混合。
    2. 范数稳定: Muon自动稳定由KFAC引起的梯度重标度，无需手动调参。
- 最终结论: 算子复合范式有效，但Hadron因其对模型架构的敏感性而被更鲁棒的 `RMSuon` 取代。
